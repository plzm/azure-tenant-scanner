$debug = $true

function Get-MDEPreferences() {
  <#
    .SYNOPSIS
    This command returns whether Realtime Monitoring is Disabled as well as connection and signature attributes.
    .DESCRIPTION
    This command returns whether Realtime Monitoring is Disabled as well as connection and signature attributes.
    .INPUTS
    None
    .OUTPUTS
    Text with names and values of several MDE preference configuration settings.
    .EXAMPLE
    PS> Get-MDEPreferences
    .LINK
    None
  #>

  [CmdletBinding()]
  param()

  Get-MpPreference | Select-Object DisableRealtimeMonitoring, MeteredConnectionUpdates, Proxy*, Signature*
}

function Get-MDEStatus() {
  <#
    .SYNOPSIS
    This command returns various MDE status properties.
    .DESCRIPTION
    This command returns various MDE status properties.
    .INPUTS
    None
    .OUTPUTS
    Text with names and values of several MDE status properties.
    .EXAMPLE
    PS> Get-MDEStatus
    .LINK
    None
  #>

  [CmdletBinding()]
  param()

  Get-MpComputerStatus | Select-Object AntispywareEnabled, AntispywareSignatureAge, AntispywareSignatureLastUpdated, AntispywareSignatureVersion, AntivirusEnabled, AntivirusSignatureAge, AntivirusSignatureLastUpdated, AntivirusSignatureVersion, BehaviorMonitorEnabled, DefenderSignaturesOutOfDate, DeviceControlPoliciesLastUpdated, FullScanOverdue, NISEnabled, NISEngineVersion, NISSignatureAge, NISSignatureLastUpdated, NISSignatureVersion, OnAccessProtectionEnabled, QuickScanAge, QuickScanOverdue, QuickScanSignatureVersion, RealTimeProtectionEnabled, RebootRequired
}

function Set-MDESignatureUpdateScheduledTask() {
  <#
    .SYNOPSIS
    This command creates a Windows scheduled task that runs hourly to update MDE signatures.
    .DESCRIPTION
    This command creates a Windows scheduled task that runs hourly to update MDE signatures. MUST BE RUN IN ELEVATED CONTEXT!
    .INPUTS
    None
    .OUTPUTS
    None
    .EXAMPLE
    PS> Set-MDESignatureUpdateScheduledTask
    .LINK
    None
  #>

  [CmdletBinding()]
  param()

  # This assumes you have Powershell 7.x+ installed
  $action = New-ScheduledTaskAction -Execute "pwsh.exe" -Argument "-Command Update-MpSignature"
  # This is if you only have Windows Powershell 5.1 installed
  #$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Command Update-MpSignature"

  $hourly = (New-TimeSpan -Hours 1)
  $days = (New-TimeSpan -Days 365)
  $trigger = New-ScheduledTaskTrigger -Once -At 12am -RepetitionInterval $hourly -RepetitionDuration $days

  $principal = New-ScheduledTaskPrincipal -GroupId "BUILTIN\Administrators"

  Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "MDE - Hourly Update" -Principal $principal
}
